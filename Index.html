<!DOCTYPE html>
<html lang="de" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffc107">
    <link rel="apple-touch-icon" href="posaune.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <title>Posaunen Trainer</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- VexFlow -->
    <script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.2/build/cjs/vexflow.js"></script>
    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <link rel="stylesheet" href="style.css">
</head>

<body>

    <!-- Compact Header / Stats Bar -->
    <div class="container-fluid bg-body-tertiary border-bottom py-2 sticky-top shadow-sm">
        <div class="container d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-3">
                <a href="javascript:void(0)" onclick="switchMainView('trainer')" class="text-decoration-none">
                    <div class="fw-bold text-warning d-flex align-items-center gap-2">
                        <img src="posaune.png" alt="Logo" height="32" class="d-inline-block align-text-top">
                        Posaune Start
                    </div>
                </a>

                <!-- Level Badge -->
                <div class="badge bg-primary rounded-pill p-2 d-flex align-items-center gap-2">
                    <i class="bi bi-trophy-fill text-warning"></i>
                    <span>Lvl <span id="displayLevel">1</span></span>
                </div>
            </div>

            <!-- XP Bar & Streak -->
            <div class="d-flex align-items-center gap-3 flex-grow-1 justify-content-end">
                <div class="d-none d-md-block w-25">
                    <div class="progress" role="progressbar" style="height: 10px;">
                        <div class="progress-bar bg-success progress-bar-striped progress-bar-animated"
                            id="xpProgressBar" style="width: 0%"></div>
                    </div>
                    <div class="text-end text-muted" style="font-size: 0.7rem;">XP bis Level Up</div>
                </div>

                <div class="text-center">
                    <div class="d-flex align-items-center gap-1 text-danger fw-bold">
                        <i class="bi bi-fire"></i> <span id="displayStreak">0</span>
                    </div>
                    <div class="text-muted" style="font-size: 0.65rem;">Tage in Folge</div>
                </div>

                <!-- Dark Mode Toggle Mini -->
                <button class="btn btn-sm btn-outline-secondary rounded-circle ms-2" id="darkModeToggleBtn"
                    onclick="toggleDarkMode()">
                    <i class="bi bi-moon-stars-fill"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="container py-3">
        <div id="view-trainer" class="view-section">
            <!-- Tabs -->
            <ul class="nav nav-pills nav-fill mb-3 gap-2 p-1 bg-body-tertiary rounded-pill shadow-sm" id="pills-tab">
                <li class="nav-item"><button class="nav-link active rounded-pill py-1" id="pills-quiz-tab"
                        data-bs-toggle="pill" data-bs-target="#pills-quiz"><i class="bi bi-controller"></i>
                        Quiz</button></li>
                <li class="nav-item"><button class="nav-link rounded-pill py-1" id="pills-learn-tab"
                        data-bs-toggle="pill" data-bs-target="#pills-learn"><i class="bi bi-book"></i> Erkunden</button>
                </li>
                <li class="nav-item"><button class="nav-link rounded-pill py-1" id="pills-theory-tab"
                        data-bs-toggle="pill" data-bs-target="#pills-theory"><i class="bi bi-lightbulb"></i>
                        Theorie</button>
                </li>
            </ul>

            <div class="tab-content" id="pills-tabContent">
                <!-- QUIZ -->
                <div class="tab-pane fade show active" id="pills-quiz">
                    <div class="card shadow border-0">
                        <div class="card-body text-center">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h3 class="mb-0">Finde die Position</h3>
                                <button class="btn btn-sm btn-outline-secondary rounded-circle"
                                    onclick="switchMainView('instructions')" title="Anleitung">
                                    <i class="bi bi-question-lg"></i>
                                </button>
                            </div>
                            <p class="text-muted mb-1" id="quizLevelHint">Modus: Anfänger</p>

                            <!-- Schwierigkeits-Selector -->
                            <div class="mb-3">
                                <div class="btn-group btn-group-sm" role="group">
                                    <input type="radio" class="btn-check" name="difficultyOverride" id="diffAuto"
                                        checked autocomplete="off" onchange="setDifficultyOverride(0)">
                                    <label class="btn btn-outline-primary" for="diffAuto">Auto (Lvl <span
                                            id="autoLevelDisplay">1</span>)</label>

                                    <input type="radio" class="btn-check" name="difficultyOverride" id="diff1"
                                        autocomplete="off" onchange="setDifficultyOverride(1)">
                                    <label class="btn btn-outline-success" for="diff1">Anfänger</label>

                                    <input type="radio" class="btn-check" name="difficultyOverride" id="diff2"
                                        autocomplete="off" onchange="setDifficultyOverride(2)">
                                    <label class="btn btn-outline-warning" for="diff2">Fortgeschritten</label>

                                    <input type="radio" class="btn-check" name="difficultyOverride" id="diff3"
                                        autocomplete="off" onchange="setDifficultyOverride(3)">
                                    <label class="btn btn-outline-danger" for="diff3">Profi</label>
                                </div>
                                <div class="text-muted small fst-italic mt-1">Wähle die Schwierigkeit oder nutze "Auto"
                                    für automatischen Fortschritt</div>
                            </div>

                            <div class="d-flex justify-content-center align-items-center mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="micModeSwitch"
                                        onchange="toggleMicMode()">
                                    <label class="form-check-label fw-bold" for="micModeSwitch">
                                        <i class="bi bi-mic-fill"></i> Mit echter Posaune spielen (Beta)
                                    </label>
                                </div>
                                <div class="text-muted small fst-italic">Aktiviere dein Mikrofon, um echte Töne zu
                                    erkennen</div>
                            </div>

                            <div class="staff-container" id="quizStaff"></div>

                            <div class="note-name-hint" id="quizCurrentSelection">Aktuelle Auswahl: 1</div>

                            <!-- HINT BUTTON -->
                            <div class="mb-2">
                                <button class="btn btn-sm btn-outline-warning rounded-pill" onclick="playQuizHint()">
                                    <i class="bi bi-ear"></i> Ton anhören (Hilfe)
                                </button>
                            </div>

                            <div id="quizNotesOnPosition" class="text-muted mb-2 fw-bold small"
                                style="min-height: 1.5em;">
                            </div>
                            <div class="feedback-container">
                                <div id="quizFeedback" class="feedback-badge bg-success text-white"></div>
                            </div>

                            <!-- DUAL VIEW: SLIDER vs TUNER -->
                            <div id="interface-wrapper" class="mt-2">

                                <!-- 1. STANDARD SLIDER VIEW -->
                                <div id="slider-interface" class="trombone-visualizer-container">
                                    <div class="viz-wrapper">
                                        <input type="range" id="quizSlideRange" min="1" max="7" step="0.05" value="1"
                                            oninput="handleQuizInput(this.value)" onchange="snapQuizInput(this.value)">

                                        <div class="trombone-visualizer">
                                            <div class="fixed-tubing"></div>
                                            <div class="inner-slide-track"></div>
                                            <div class="outer-slide" id="quizVisualSlide">
                                                <div class="slide-handle">
                                                    <div class="slide-handle-icon"><i
                                                            class="bi bi-arrow-left-right"></i>
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- Marker -->
                                            <div class="pos-marker" id="quiz-marker-1" onclick="snapQuizInput(1)"
                                                style="left: calc(95px + 0px);"><span>1</span></div>
                                            <div class="pos-marker" id="quiz-marker-2" onclick="snapQuizInput(2)"
                                                style="left: calc(95px + 40px);"><span>2</span></div>
                                            <div class="pos-marker" id="quiz-marker-3" onclick="snapQuizInput(3)"
                                                style="left: calc(95px + 80px);"><span>3</span></div>
                                            <div class="pos-marker" id="quiz-marker-4" onclick="snapQuizInput(4)"
                                                style="left: calc(95px + 120px);"><span>4</span></div>
                                            <div class="pos-marker" id="quiz-marker-5" onclick="snapQuizInput(5)"
                                                style="left: calc(95px + 160px);"><span>5</span></div>
                                            <div class="pos-marker" id="quiz-marker-6" onclick="snapQuizInput(6)"
                                                style="left: calc(95px + 200px);"><span>6</span></div>
                                            <div class="pos-marker" id="quiz-marker-7" onclick="snapQuizInput(7)"
                                                style="left: calc(95px + 240px);"><span>7</span></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 2. TUNER INTERFACE (Hidden by default) -->
                                <div id="tuner-interface" class="d-none text-center py-3">
                                    <div class="tuner-display mb-3">
                                        <div class="note-display display-1 fw-bold" id="detectedNote">--</div>
                                        <div class="freq-display text-muted small" id="detectedFreq">0 Hz</div>
                                    </div>

                                    <div class="tuner-gauge-wrapper">
                                        <div class="tuner-gauge">
                                            <div class="gauge-center-line"></div>
                                            <div class="gauge-needle" id="tunerNeedle"></div>
                                        </div>
                                        <div class="d-flex justify-content-between px-2 text-muted small mt-1">
                                            <span>b (Zu tief)</span>
                                            <span class="text-success fw-bold">Perfekt</span>
                                            <span># (Zu hoch)</span>
                                        </div>
                                    </div>

                                    <div class="mt-3">
                                        <div class="alert alert-info py-2 small d-inline-block">
                                            <i class="bi bi-info-circle"></i> Spiele den Ton lang und gleichmäßig.
                                        </div>
                                    </div>
                                </div>

                            </div>

                            <!-- BUTTONS -->
                            <div class="mobile-controls-container mb-4">
                                <button class="btn btn-outline-secondary pos-btn active-pos"
                                    onclick="snapQuizInput(1)">1</button>
                                <button class="btn btn-outline-secondary pos-btn" onclick="snapQuizInput(2)">2</button>
                                <button class="btn btn-outline-secondary pos-btn" onclick="snapQuizInput(3)">3</button>
                                <button class="btn btn-outline-secondary pos-btn" onclick="snapQuizInput(4)">4</button>
                                <button class="btn btn-outline-secondary pos-btn" onclick="snapQuizInput(5)">5</button>
                                <button class="btn btn-outline-secondary pos-btn" onclick="snapQuizInput(6)">6</button>
                                <button class="btn btn-outline-secondary pos-btn" onclick="snapQuizInput(7)">7</button>
                            </div>

                            <div class="d-grid gap-2 col-6 mx-auto mt-2">
                                <button class="btn btn-lg btn-success shadow" id="checkAnswerBtn"
                                    onclick="checkQuizAnswer()">Antwort prüfen</button>
                                <button class="btn btn-lg btn-primary shadow" id="nextBtn" style="display:none;"
                                    onclick="nextQuestion()">Nächste Note</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- LEARN -->
                <div class="tab-pane fade" id="pills-learn">
                    <div class="card shadow border-0">
                        <div class="card-body text-center">
                            <h2 class="card-title mb-3">Erkunden</h2>
                            <div class="staff-container" id="learnStaff"></div>

                            <!-- Interaktive Noten-Buttons -->
                            <div id="learnNoteInteraction"
                                class="my-3 d-flex justify-content-center flex-wrap gap-2 align-items-center"
                                style="min-height: 50px;">
                                <div class="text-muted fst-italic small d-none d-md-block">Bewege den Zug, um Töne zu
                                    sehen</div>
                                <div class="text-muted fst-italic small d-md-none">Tippe unten auf eine Zahl (1-7), um
                                    Töne zu sehen</div>
                            </div>

                            <div class="d-flex justify-content-center gap-3 mb-3 align-items-center">
                                <div class="form-check form-switch small">
                                    <input class="form-check-input" type="checkbox" id="autoPlayCheck" checked>
                                    <label class="form-check-label text-muted" for="autoPlayCheck">Auto-Play
                                        (Grundton)</label>
                                </div>
                            </div>

                            <div class="trombone-visualizer-container">
                                <div class="viz-wrapper">
                                    <input type="range" id="learnSlideRange" min="1" max="7" step="0.05" value="1"
                                        oninput="handleLearnInput(this.value)"
                                        onchange="handleLearnRelease(this.value)">
                                    <div class="trombone-visualizer">
                                        <div class="fixed-tubing"></div>
                                        <div class="inner-slide-track"></div>
                                        <div class="outer-slide" id="learnVisualSlide">
                                            <div class="slide-handle">
                                                <div class="slide-handle-icon"><i class="bi bi-arrow-left-right"></i>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="pos-marker" id="learn-marker-1" onclick="handleLearnRelease(1)"
                                            style="left: calc(95px + 0px);"><span>1</span></div>
                                        <div class="pos-marker" id="learn-marker-2" onclick="handleLearnRelease(2)"
                                            style="left: calc(95px + 40px);"><span>2</span></div>
                                        <div class="pos-marker" id="learn-marker-3" onclick="handleLearnRelease(3)"
                                            style="left: calc(95px + 80px);"><span>3</span></div>
                                        <div class="pos-marker" id="learn-marker-4" onclick="handleLearnRelease(4)"
                                            style="left: calc(95px + 120px);"><span>4</span></div>
                                        <div class="pos-marker" id="learn-marker-5" onclick="handleLearnRelease(5)"
                                            style="left: calc(95px + 160px);"><span>5</span></div>
                                        <div class="pos-marker" id="learn-marker-6" onclick="handleLearnRelease(6)"
                                            style="left: calc(95px + 200px);"><span>6</span></div>
                                        <div class="pos-marker" id="learn-marker-7" onclick="handleLearnRelease(7)"
                                            style="left: calc(95px + 240px);"><span>7</span></div>
                                    </div>
                                </div>
                            </div>

                            <div class="mobile-controls-container">
                                <button class="btn btn-outline-secondary pos-btn active-pos"
                                    onclick="setLearnPosition(1)">1</button>
                                <button class="btn btn-outline-secondary pos-btn"
                                    onclick="setLearnPosition(2)">2</button>
                                <button class="btn btn-outline-secondary pos-btn"
                                    onclick="setLearnPosition(3)">3</button>
                                <button class="btn btn-outline-secondary pos-btn"
                                    onclick="setLearnPosition(4)">4</button>
                                <button class="btn btn-outline-secondary pos-btn"
                                    onclick="setLearnPosition(5)">5</button>
                                <button class="btn btn-outline-secondary pos-btn"
                                    onclick="setLearnPosition(6)">6</button>
                                <button class="btn btn-outline-secondary pos-btn"
                                    onclick="setLearnPosition(7)">7</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- THEORIE -->
                <div class="tab-pane fade" id="pills-theory">
                    <div class="card shadow border-0">
                        <div class="card-body text-center">
                            <h2 class="card-title mb-3"><i class="bi bi-lightbulb-fill text-warning"></i>
                                Posaunen-Wissen</h2>
                            <p class="text-muted small">Lerne die Grundlagen der Posaune kennen</p>

                            <!-- Flashcard Container -->
                            <div class="flashcard-container my-4">
                                <div class="flashcard" id="theoryCard">
                                    <div class="card-number mb-2 text-muted small">Frage <span
                                            id="theoryCardNum">1</span> von <span id="theoryCardTotal">-</span>
                                    </div>
                                    <h4 class="mb-4" id="theoryQuestion">Lade Fragen...</h4>

                                    <!-- Options Container -->
                                    <div id="theoryOptions" class="d-grid gap-2">
                                        <!-- Buttons werden per JS eingefügt -->
                                    </div>
                                </div>
                            </div>

                            <!-- Progress -->
                            <div class="progress mb-2" style="height: 8px;">
                                <div class="progress-bar bg-info" id="theoryProgress" style="width: 0%"></div>
                            </div>
                            <div class="text-muted small">
                                <span id="theoryCorrect">0</span> richtig |
                                <span id="theoryWrong">0</span> falsch
                            </div>

                            <!-- Reset Button -->
                            <button class="btn btn-sm btn-outline-secondary mt-3" onclick="resetTheoryQuiz()">
                                <i class="bi bi-arrow-clockwise"></i> Quiz neu starten
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-instructions" class="view-section d-none">
        <div class="row justify-content-center">
            <div class="col-lg-10 col-xl-8">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="mb-0"><i class="bi bi-info-circle-fill text-warning"></i> Anleitung & Hilfe</h2>
                    <button class="btn btn-outline-primary rounded-pill" onclick="switchMainView('trainer')">
                        <i class="bi bi-arrow-left"></i> Zurück
                    </button>
                </div>

                <div class="card shadow border-0 mb-4">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-music-note-beamed"></i> Willkommen beim Posaune Start
                            Trainer!</h5>
                        <p class="card-text">
                            Diese WebApp hilft dir, die ersten Töne auf der Posaune zu lernen und die richtigen
                            Zugpositionen zu verinnerlichen.
                        </p>
                    </div>
                </div>

                <div class="card shadow border-0 mb-4">
                    <div class="card-header bg-body-secondary">
                        <h5 class="mb-0">Die drei Bereiche</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <!-- Quiz -->
                            <div class="col-md-4">
                                <div class="p-3 border rounded h-100">
                                    <h6 class="text-success"><i class="bi bi-controller"></i> Quiz (Praxis)</h6>
                                    <p class="small">Trainiere das Treffen der richtigen Zugpositionen.</p>
                                    <ul class="small ps-3">
                                        <li><strong>Schwierigkeit:</strong> Wähle manuell (Anfänger/Profi) oder lass
                                            "Auto" mit deinem Level wachsen.</li>
                                        <li><strong>Mikrofon (Beta):</strong> Spiele echte Töne auf deiner Posaune, um
                                            zu antworten!</li>
                                        <li><strong>Hilfe:</strong> Klicke auf "Ton anhören", wenn du unsicher bist.
                                        </li>
                                    </ul>
                                </div>
                            </div>

                            <!-- Erkunden -->
                            <div class="col-md-4">
                                <div class="p-3 border rounded h-100">
                                    <h6 class="text-primary"><i class="bi bi-book"></i> Erkunden</h6>
                                    <p class="small">Experimentiere ohne Druck.</p>
                                    <ul class="small ps-3">
                                        <li>Bewege den Zug und sieh, welche Töne dort liegen.</li>
                                        <li>Höre dir die Töne an.</li>
                                        <li>Nutze <strong>Auto-Play</strong>, um den Grundton beim Ziehen zu hören.</li>
                                    </ul>
                                </div>
                            </div>

                            <!-- Theorie -->
                            <div class="col-md-4">
                                <div class="p-3 border rounded h-100">
                                    <h6 class="text-warning"><i class="bi bi-lightbulb"></i> Theorie</h6>
                                    <p class="small">Teste dein Wissen über die Posaune.</p>
                                    <ul class="small ps-3">
                                        <li>Multiple-Choice Fragen zu Aufbau, Geschichte und Musiktheorie.</li>
                                        <li>4 Schwierigkeitsstufen (Leicht bis Experte).</li>
                                        <li>Sammle extra XP für richtige Antworten!</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card shadow border-0 mb-4">
                    <div class="card-header bg-body-secondary">
                        <h5 class="mb-0">Steuerung</h5>
                        <li><strong>PC / Tablet:</strong> Ziehe den Slider am Griff oder klicke direkt auf die
                            Zahlen im Bild.</li>
                        <li><strong>Smartphone:</strong> Nutze die großen runden Buttons (1-7) unter der Grafik.
                        </li>
                        </ul>
                    </div>
                </div>

                <!-- Zugtabelle -->
                <div class="card shadow border-0 mb-4">
                    <div class="card-header bg-warning text-dark fw-bold">
                        <i class="bi bi-grid-3x3"></i> Zugtabelle & Positionen
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover mb-0 align-middle text-center table-ref"
                                id="referenceTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th style="width: 10%">Pos</th>
                                        <th style="width: 30%">Anfänger (B-Dur)</th>
                                        <th style="width: 30%">Fortgeschritten</th>
                                        <th style="width: 30%">Profi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Wird per JS gefüllt -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Statistiken -->
                <div class="card shadow border-0 mb-4">
                    <div class="card-header bg-info text-white fw-bold">
                        <i class="bi bi-graph-up"></i> Deine Statistiken
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <h6 class="text-muted small">Heute</h6>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>Richtig beantwortet:</span>
                                    <span class="badge bg-success" id="statTodayCorrect">0</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mt-1">
                                    <span>Gesamt heute:</span>
                                    <span class="badge bg-secondary" id="statTodayTotal">0</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-muted small">Insgesamt</h6>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>Richtig:</span>
                                    <span class="badge bg-success" id="statTotalCorrect">0</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mt-1">
                                    <span>Fragen:</span>
                                    <span class="badge bg-secondary" id="statTotalQuestions">0</span>
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">Genauigkeit: <span id="statAccuracy"
                                            class="fw-bold">0%</span></small>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <h6 class="text-muted small mb-2">Genauigkeit pro Position</h6>
                        <div id="positionStatsContainer" class="small">
                            <!-- Wird per JS gefüllt -->
                        </div>
                    </div>
                </div>

                <div class="text-center"><button class="btn btn-primary btn-lg"
                        onclick="switchMainView('trainer')">Zurück zum Trainer</button></div>
            </div>
        </div>
    </div>
    </div>

    <!-- Footer -->
    <footer class="text-center text-muted py-4 mt-5 border-top small">
        <div class="container">
            Erstellt von M. Schellenberger 11/2025 mit Gemini (<a href="https://Michael.schellenberger.biz"
                target="_blank" class="text-decoration-none text-muted">Michael.schellenberger.biz</a>)
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="script.js"></script>
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('Service Worker registered!', reg))
                    .catch(err => console.log('Service Worker registration failed', err));
            });
        }
    </script>
</body>

</html>